/*
-----------------------------------------------------------------------------
A
     __      _   _   _   ______
    |   \   | | | | | | |  ____)                    _
    | |\ \  | | | | | | | |         ___      ___   (_)   ___
    | | \ \ | | | | | | | |____    / _ \   / ___ \  _   / _ \   ___
    | |  \ \| | | | | | |  ____)  | / \ | | |  | | | | | / \ | / _ )
    | |   \ | | | | | | | |_____  | | | | | |__| | | | | | | | | __/
    |_|    \ _| |_| |_| |_______) |_| |_|  \___| | |_| |_| |_| |___|
                                             __/ |                 
                                            \___/   
                                                
                                                
                                                                 F i l e


Copyright: NIIEngine Team Group

Home page: www.niiengine.com 

Email: niiengine@gmail.com OR niiengine@163.com

Licence: commerce(www.niiengine.com/license)(Three kinds)
------------------------------------------------------------------------------
*/

#include "NiiPreProcess.h"
#include "NiiFileSerializer.h"
#include "NiiException.h"

namespace NII
{
    //------------------------------------------------------------------------
    #define N_SERIAL_FILE_HEADER_SIZE 2466
    #define N_SERIAL_TRADER_MARK_SIZE 12
    static const Nui8 nii_serializer_header[N_SERIAL_FILE_HEADER_SIZE] =
    {   //1  //2  //3  //4  //5  //6  //7  //8  //9  //10 //11 //12 //13 //14
        0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,//1
        0x49,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,//2
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,//3
        0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,//4
        0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,//5
        0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,//6
        0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,//7
        0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,//8
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,//9
        0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,//10
        0x4E,0x49,0x49,0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,//11
        0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x4E,//12
        0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//13
        0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,//14
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//15
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,//16
        0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,//17
        0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,//18
        0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//19
        0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,//20
        0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x0A,//21
        0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//22
        0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x4E,0x49,0x49,0x20,//23
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,//24
        0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,//25
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//26
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//27
        0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//28
        0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//29
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,//30
        0x20,0x20,0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,//31
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//32
        0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//33
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x4E,0x49,//34
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//35
        0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//36
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,//37
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//38
        0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//39
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x0A,0x4E,0x49,//40
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//41
        0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//42
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,//43
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//44
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//45
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,//46
        0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//47
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//48
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,//49
        0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//50
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//51
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//52
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//53
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//54
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//55
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,//56
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//57
        0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//58
        0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x20,//59
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//60
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//61
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,//62
        0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//63
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//64
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,//65
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//66
        0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//67
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,//68
        0x49,0x0A,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//69
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//70
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//71
        0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,//72
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//73
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//74
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//75
        0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,//76
        0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,//77
        0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x4E,0x49,0x49,//78
        0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,//79
        0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//80
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,//81
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//82
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//83
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,//84
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//85
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//86
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,//87
        0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,//88
        0x0A,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,//89
        0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,//90
        0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//91
        0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,//92
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//93
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//94
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//95
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,//96
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//97
        0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,//98
        0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x20,0x20,0x20,//99
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//100
        0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//101
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,//102
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//103
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//104
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,//105
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//106
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//107
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x0A,//108
        0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//109
        0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,//110
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x4E,//111
        0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//112
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//113
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//114
        0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//115
        0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//116
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,//117
        0x20,0x20,0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,//118
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//119
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//120
        0x49,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,//121
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//122
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//123
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,//124
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//125
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//126
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x0A,0x4E,0x49,//127
        0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//128
        0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//129
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x4E,0x49,0x49,//130
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//131
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//132
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,//133
        0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//134
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//135
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,//136
        0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//137
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//138
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//139
        0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//140
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//141
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//142
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,//143
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//144
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,//145
        0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x20,//146
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//147
        0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//148
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x4E,0x49,0x49,0x20,0x20,//149
        0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//150
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x20,//151
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,//152
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//153
        0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//154
        0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,//155
        0x49,0x0A,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,//156
        0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//157
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,//158
        0x49,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//159
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,//160
        0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,//161
        0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,//162
        0x49,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,//163
        0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x4E,//164
        0x49,0x49,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,//165
        0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x0A,0x4E,0x49,0x49,0x4E,0x49,//166
        0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,//167
        0x20,0x4E,0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//168
        0x20,0x20,0x20,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x20,//169
        0x20,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,//170
        0x49,0x4E,0x49,0x49,0x20,0x20,0x20,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,//171
        0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,//172
        0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x4E,//173
        0x49,0x49,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,//174
        0x20,0x20,0x20,0x4E,0x49,0x49,0x4E,0x49,0x49,0x20,0x20,0x4E,0x49,0x49,//175
        0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,0x49,0x4E,0x49,//176
        0x49,0x0A                                                             //2
    };
    //------------------------------------------------------------------------
    static const Nui8 nii_trademark_char[N_SERIAL_TRADER_MARK_SIZE] =
    {
        0x4E,0x49,0x49,0x45,0x6E,0x67,0x69,0x6E,0x65,3,0,0
    };
    //------------------------------------------------------------------------
    FileSerializer::FileSerializer() :
        Serializer(0),
        mVersion(30000),
        mFormat(F_EC_None),
        mComHeaderPos(0),
        mNextPos(0),
        mListener(0)
    {
    }
    //------------------------------------------------------------------------
    FileSerializer::FileSerializer(const DataStream * src, bool flip) :
        Serializer(src, flip),
        mVersion(30000),
        mFormat(F_EC_None),
        mComHeaderPos(0),
        mNextPos(0),
        mListener(0)
    {
    }
    //------------------------------------------------------------------------
    FileSerializer::FileSerializer(const FileSerializer & obj) :
        Serializer(obj.mStream, obj.mFlipEndian),
        mUnitID(obj.mUnitID),
        mObjectID(obj.mObjectID),
        mUnitSize(obj.mUnitSize),
        mFileSize(obj.mFileSize),
        mNextPos(obj.mNextPos),
        mVersion(obj.mVersion),
        mFormat(obj.mFormat),
        mComHeaderPos(obj.mComHeaderPos),
        mChunkSize(obj.mChunkSize),
        mListener(obj.mListener)
    {
    }
    //------------------------------------------------------------------------
    FileSerializer::~FileSerializer()
    {

    }
    //------------------------------------------------------------------------
    void FileSerializer::setFormat(SerialFormat m)
    {
        mFormat = m;
    }
    //------------------------------------------------------------------------
    SerialFormat FileSerializer::getFormat() const
    {
        return mFormat;
    }
    //------------------------------------------------------------------------
    void FileSerializer::writeFileHeader()
    {
        write(nii_serializer_header, N_SERIAL_FILE_HEADER_SIZE);
    }
    //------------------------------------------------------------------------
    void FileSerializer::writeHeader()
    {
        mComHeaderPos = mStream->tell();
        Nui16 val = NorEndian;
        write(nii_trademark_char, N_SERIAL_TRADER_MARK_SIZE);
        write(&val, 1);
        write(&mUnitID, 1);
        write(&mObjectID, 1);
        write(&mFormat, 1);
        write(&mUnitSize, 1);
        write(&mFileSize, 1);
        write(&mVersion, 1);
        write(&mNextPos, 1);

        mNextPos = mStream->tell();
    }
    //------------------------------------------------------------------------
    void FileSerializer::readFileHeader()
    {
        mStream->skip(0);
        static Nui8 header[N_SERIAL_FILE_HEADER_SIZE];
        read(header, N_SERIAL_FILE_HEADER_SIZE);
        if(memcmp(nii_serializer_header, header, N_SERIAL_FILE_HEADER_SIZE) != 0)
        {
            N_EXCEPT(Internal, _I18n("不是引擎文件,数据流 :") + mStream->getName());
        }
    }
    //------------------------------------------------------------------------
    NCount FileSerializer::readHeader()
    {
        static Nui8 component[N_SERIAL_TRADER_MARK_SIZE];
        read(component, N_SERIAL_TRADER_MARK_SIZE);
        if(memcmp(nii_trademark_char, component, N_SERIAL_TRADER_MARK_SIZE) == 0)
        {
            check(mStream, 0);

            Nui16 endian;
            read(&endian, 1);
            if(endian == NorEndian)
            {
                read(&mUnitID, 1);
                read(&mObjectID, 1);
                read(&mFormat, 1);
                read(&mUnitSize, 1);
                read(&mFileSize, 1);
                read(&mVersion, 1);
                read(&mNextPos, 1);

                if(mUnitID != getUnit())
                {
                    N_EXCEPT(Internal, _I18n("数据流: ") + mStream->getName() + _I18n("错误单元:") + mUnitID);
                }

                if(!isVersion(mVersion))
                {
                    N_EXCEPT(Internal, _I18n("数据流: ") + mStream->getName() +
                        _I18n("不支持文件版本:") + (Nui32)mVersion);
                }
            }
            else
            {
                N_EXCEPT(Internal, _I18n("数据流: ") + mStream->getName() + _I18n("字节序逻辑错误"));
            }
        }
        else
        {
            N_EXCEPT(Internal, _I18n("不是引擎数据,数据流: ") + mStream->getName());
        }
        return mUnitSize;
    }
    //------------------------------------------------------------------------
    bool FileSerializer::searchHeader()
    {
        NCount r, j, readsize = N_SERIAL_TRADER_MARK_SIZE;
        Nui8 component[N_SERIAL_TRADER_MARK_SIZE];
        NCount temp = mStream->tell();
        while(!mStream->end())
        {
            read(component, readsize);
            for(r = 0; r < readsize; ++r)
            {
                for(j = 0; ; ++r, ++j)
                {
                    checkagian :
                    if(component[r] == nii_trademark_char[j])
                    {
                        if(j + 1 == readsize)
                        {
                            mStream->skip(readsize - r - 1);
                            check(mStream, 0);

                            Nui16 endian;
                            read(&endian, 1);
                            if(endian == NorEndian)
                            {
                                read(&mUnitID, 1);
                                read(&mObjectID, 1);
                                read(&mFormat, 1);
                                read(&mUnitSize, 1);
                                read(&mFileSize, 1);
                                read(&mVersion, 1);
                                read(&mNextPos, 1);
                            }
                            else
                            {
                                N_EXCEPT(Internal, _I18n("数据流: ") + mStream->getName() + _I18n("字节序逻辑错误"));
                            }
                            //找到了
                            return true;
                        }
                        else if(r + 1 == readsize)
                        {
                            r = 0;
                            ++j;
                            read(component, readsize);
                            goto checkagian;
                        }
                        else
                        {
                            continue;
                        }
                    }
                    else
                    {
                        break;
                    }
                }
            }
        }
        // 找不到
        mStream->seek(temp);
        return false;
    }
    //------------------------------------------------------------------------
    bool FileSerializer::skipHeader()
    {
        bool re = false;
        mStream->seek(mNextPos);
        if(!mStream->end() && readHeader())
            re = true;
        return re;
    }
    //------------------------------------------------------------------------
    bool FileSerializer::skipToNextUnit()
    {
        return false;
    }
    //------------------------------------------------------------------------
    void FileSerializer::reviseWrite()
    {
        mUnitSize = mStream->tell() - mNextPos;
        mNextPos = mStream->tell();
        mStream->seek(mComHeaderPos);
        writeHeader();
        mStream->seek(mNextPos);
    }
    //------------------------------------------------------------------------
    void FileSerializer::setListener(Listener * obj)
    {
        mListener = obj;
    }
    //------------------------------------------------------------------------
    FileSerializer::Listener * FileSerializer::getListener() const
    {
        return mListener;
    }
    //------------------------------------------------------------------------
    bool FileSerializer::isVersion(SerialVer ver) const
    {
        return false;
    }
    //------------------------------------------------------------------------
}